import { addIcon, Plugin } from "obsidian";
import { Dropbox, DropboxAuth } from "dropbox";
import Bluebird from "bluebird";

type file = { path: string; contents: string };

export default class DropboxBackups extends Plugin {
    dbx: Dropbox;
    dbxAuth: DropboxAuth;
    clientId = "40ig42vaqj3762d";

    lastBackup: Date;

    allFiles: file[];

    async getAllFiles() {
        const vaultPath = this.app.vault.getName();
        this.allFiles = await Promise.all(
            this.app.vault.getFiles().map(async (tfile) => {
                const fileContents = await this.app.vault.read(tfile);
                return {
                    path: `${vaultPath}/${tfile.path}`,
                    contents: fileContents,
                };
            })
        );
    }

    async backup(): Promise<void> {
        await this.getAllFiles();
        if (this.allFiles && this.allFiles.length > 0) {
            const now = Date.now();
            // Add 1 because no one thinks of January as 0.
            const month = new Date(now).getMonth() + 1;
            const year = new Date(now).getFullYear();
            const pathPrefix = `/${year}/${month}/${now}`;
            console.log(`Backing up to: ${pathPrefix}`);

            await Bluebird.map(
                this.allFiles,
                async (file: file) => {
                    return await this.dbx.filesUpload({
                        path: `${pathPrefix}/${file.path}`,
                        // @ts-ignore
                        mode: "overwrite",
                        mute: true,
                        contents: file.contents,
                    });
                },
                { concurrency: 1 }
            );
            console.log(`Backup to ${pathPrefix} complete!`);
            this.lastBackup = new Date(now);
        }
    }

    async onload(): Promise<void> {
        console.log("Loading Dropbox Backups plugin ...");

        this.registerObsidianProtocolHandler(
            "dropbox-backups-auth",
            async (params) => {
                this.dbxAuth.setCodeVerifier(
                    sessionStorage.getItem("codeVerifier") ||
                        localStorage.getItem("codeVerifier")
                );

                const accessTokenResponse = await this.dbxAuth.getAccessTokenFromCode(
                    "obsidian://dropbox-backups-auth",
                    params.code
                );

                this.dbxAuth.setAccessToken(
                    // @ts-ignore
                    accessTokenResponse.result.access_token
                );

                this.dbx = new Dropbox({
                    auth: this.dbxAuth,
                });

                await this.backup();
            }
        );

        this.dbxAuth = new DropboxAuth();
        this.dbxAuth.setClientId(this.clientId);
        const authUrl = await this.dbxAuth.getAuthenticationUrl(
            "obsidian://dropbox-backups-auth",
            undefined,
            "code",
            "offline",
            undefined,
            undefined,
            true
        );
        // @ts-ignore
        sessionStorage.setItem("codeVerifier", this.dbxAuth.codeVerifier);
        // @ts-ignore
        localStorage.setItem("codeVerifier", this.dbxAuth.codeVerifier);

        window.location.assign(String(authUrl));
        addIcon(
            "dropbox-backups",
            `<g xmlns="http://www.w3.org/2000/svg">
    <g>
        <path d="M0.686,13.596c2.095,1.715,4.188,3.431,6.282,5.146c0.03,0.024,0.067,0.044,0.108,0.058    c0.063,0.023,0.529,0.216,1.07,0.329c4.34,0.903,9.512-3.974,12.815-5.994c1.162-0.71,4.865-2.348,2.675-4.168    c-2.096-1.741-4.19-3.482-6.287-5.224c-3.574-2.97-11.366,4.044-13.999,5.67C2.199,10.126-1.52,11.79,0.686,13.596z M15.053,4.246    c0.161,0.044,0.323,0.104,0.486,0.185c0.074,0.037,0.147,0.078,0.222,0.121c0.121,0.07,0.128,0.219,0.019,0.327    c-0.11,0.108-0.083,0.124,0.06,0.036c0.143-0.088,0.636,0.084,1.063,0.435c0.953,0.782,1.864,1.763,2.711,2.466    c1.5,1.247,3.898,2.713,1.354,4.269c-2.096,1.281-4.191,2.562-6.287,3.844c-0.665,0.406-1.354,0.948-2.071,1.415    c-0.462,0.302-0.971,0.417-1.105,0.307c-0.135-0.111-0.441-0.007-0.683,0.232c-0.242,0.238-0.811,0.498-1.26,0.426    c-0.448-0.072-0.938-0.381-1.135-0.541c-0.196-0.161-0.031-0.601,0.366-0.984c0.013-0.012,0.024-0.025,0.039-0.037    c0.396-0.383,0.626-0.771,0.511-0.865c-0.115-0.094-0.522,0.148-0.911,0.541c-0.012,0.011-0.022,0.023-0.035,0.035    c-0.389,0.393-1.043,0.431-1.463,0.087s-0.448-0.943-0.062-1.338c0.011-0.011,0.021-0.022,0.033-0.034    c0.386-0.396,0.513-0.868,0.282-1.057c-0.229-0.189-0.739-0.03-1.136,0.354c-0.013,0.012-0.025,0.024-0.038,0.036    c-0.396,0.385-0.41,0.371-0.019-0.018c0.012-0.012,0.023-0.024,0.036-0.036c0.392-0.389,0.38-0.399-0.02-0.019    c-0.013,0.013-0.027,0.025-0.04,0.038c-0.398,0.381-0.84,0.595-0.989,0.473c-0.09-0.074-0.18-0.148-0.271-0.221    c-0.09-0.074-0.185-0.149-0.279-0.225c-0.156-0.123,0.039-0.535,0.436-0.919c0.036-0.035,0.07-0.07,0.106-0.104    c0.396-0.385,0.402-1.106,0.506-1.648c0.069-0.364,0.312-0.706,0.725-0.961L9.32,8.94c0.47-0.29,1.172-0.837,1.566-1.223    c0.966-0.94,1.946-1.894,2.938-2.861C14.221,4.469,14.775,4.169,15.053,4.246z M9.645,6.587c0.786-0.485,1.616-1.169,2.48-1.689    c0.473-0.285,0.605-0.284,0.259-0.069c-0.347,0.214-0.947,0.704-1.338,1.093c-2.346,2.33-4.688,4.655-7.019,6.968    c-0.393,0.389-1.04,0.441-1.36,0.038c-0.319-0.403-0.086-1.135,0.312-1.518c0.45-0.432,0.896-0.86,1.337-1.285    c0.398-0.382,1.103-0.928,1.572-1.218C7.14,8.133,8.392,7.36,9.645,6.587z M2.571,11.11C2.747,10.901,3,10.69,3.346,10.477    c0.245-0.151,0.489-0.302,0.733-0.453c0.404-0.25,0.41-0.143,0.012,0.24c-0.369,0.354-0.742,0.712-1.119,1.073    C2.573,11.718,2.216,11.533,2.571,11.11z"/>
        <path d="M42.928,22.182c-3.438-2.918-10.138,3.09-12.78,4.693c-1.326,0.806-3.562,1.646-3.548,3.164    c0.005,0.552,0.042,0.904-0.25,0.918c-0.171,0.008-0.346,0.035-0.522,0.083c-0.148,0.04-0.277,0.095-0.393,0.163    c-0.204,0.119-0.612-0.2-1.165-0.188c-0.677,0.014-1.644,0.479-2.677,1.133c-0.467,0.295-0.511,0.243-0.115-0.143    c0.421-0.409,0.816-0.787,1.179-1.101c2.208-1.917-1.679-3.561-2.908-4.307c-2.534-1.538-5.068-3.077-7.604-4.615    c-3.914-2.376-8.198,3.041-10.756,5.211c-0.018,0.016-0.03,0.029-0.038,0.042c-0.017,0.026-0.322,0.419-0.413,0.964    c-0.283,1.726,2.396,2.639,3.821,3.476c2.474,1.453,4.948,2.906,7.421,4.36c0.078,0.046,0.156,0.084,0.234,0.119    c0.133,0.06-0.169-0.087-0.707-0.21c-0.413-0.094-0.835-0.117-1.269-0.001c-2.493,0.669-0.876,2.991,0.614,3.909    c3.536,2.177,7.073,4.354,10.609,6.532c0.01,0.007,0.021,0.01,0.036,0.013c0.021,0.004,0.048,0.017,0.059,0.028    c0.005,0.007,0.012,0.013,0.024,0.018c0.649,0.247,1.258,0.299,1.777,0.182c0.538-0.122,0.995-0.461,1.104-0.533    c0.107-0.072,0.387,0.315,0.915,0.479c0.456,0.141,1.085,0.065,1.939-0.257c1.869-0.708,3.657-2.209,5.347-3.25    c1.967-1.211,3.934-2.422,5.899-3.635c0.033-0.021,0.062-0.038,0.085-0.058c0.045-0.035,0.438-0.336,0.832-0.723    c0.66-0.648,1.158-1.437,0.864-2.388c-0.217-0.704-1.819-0.388-2.25-0.221c-1.137,0.44-2.161,1.125-3.283,0.834    c-0.535-0.138-0.444-0.386,0.106-0.431c3.551-0.289,7.55-3.777,10.106-5.279c1.514-0.889,3.576-1.555,3.743-3.483    C49.098,26.188,43.932,23.033,42.928,22.182z M11.482,37.58c-0.104,0.111-0.585-0.11-0.34-0.291    C11.389,37.108,11.587,37.469,11.482,37.58z M4.727,28.746c-0.384,0.397-0.902,0.527-1.124,0.259s-0.047-0.839,0.337-1.235    c1.424-1.472,2.823-2.915,4.192-4.327c0.385-0.396,1.059-0.829,1.51-0.783c0.451,0.046,0.482,0.52,0.099,0.916    C8.067,25.298,6.395,27.021,4.727,28.746z M11.852,33.215c-0.341,0.318-1.019,0.379-1.515,0.135    c-1.159-0.572-2.654-1.33-3.993-2.161c-0.469-0.292-0.541-0.844-0.173-1.208c0.368-0.365,0.644-0.677,0.619-0.695    c-0.025-0.018-0.341,0.265-0.707,0.632c-0.366,0.368-0.844,0.541-1.062,0.378s-0.143-0.551,0.164-0.857    c0.187-0.186,0.371-0.37,0.558-0.555c0.073-0.073,0.147-0.146,0.223-0.22c0.123-0.121,0.128-0.585,0.295-0.979    c0.091-0.216,0.246-0.424,0.465-0.61l3.754-3.187c0.421-0.357,0.884-0.582,1.029-0.5c0.085,0.048,0.172,0.099,0.263,0.154    c0.959,0.583,11.188,5.659,9.043,7.518c-1.379,1.196-2.757,2.393-4.136,3.589c-0.599,0.519-1.136,0.738-1.654,0.764    c-0.552,0.027-0.743-0.399-0.452-0.694c0.292-0.296,0.464-0.573,0.384-0.619c-0.08-0.048-0.405,0.156-0.728,0.455    c-0.321,0.299-0.883,0.4-1.237,0.201c-0.355-0.198-0.367-0.618-0.035-0.924c0.333-0.306,0.358-0.696,0.058-0.873    C12.713,32.783,12.192,32.897,11.852,33.215z M16.492,36.129c-0.165,0.146-0.281,0.247-0.335,0.291    c-0.745,0.612-1.48,0.572-2.227,0.338c-0.526-0.166-0.503-0.204,0.048-0.172c0.652,0.038,1.302-0.088,1.94-0.331    C16.436,36.062,16.676,35.968,16.492,36.129z M23.126,44.648c0.04,0.551-0.173,0.729-0.644,0.439    c-0.035-0.021-0.07-0.044-0.106-0.065c-0.47-0.29-0.586-0.79-0.259-1.117c0.327-0.328,0.37-0.73,0.098-0.898    c-0.272-0.167-0.773-0.048-1.119,0.269c-0.346,0.315-1.008,0.338-1.478,0.048c-0.422-0.26-0.846-0.521-1.269-0.781    c-0.47-0.289-0.589-0.791-0.265-1.12c0.325-0.329,0.516-0.64,0.427-0.694c-0.089-0.056-0.438,0.158-0.781,0.476    c-0.343,0.318-0.899,0.403-1.243,0.191c-0.345-0.212-0.343-0.64,0.004-0.955s0.417-0.701,0.155-0.861l-0.471-0.29    c-0.02-0.012-0.039-0.026-0.058-0.039c-0.032-0.021-0.335,0.219-0.679,0.539c-0.343,0.32-1.003,0.345-1.474,0.055    c-0.447-0.274-0.894-0.55-1.34-0.825c-0.128-0.079-0.261-0.175-0.393-0.279c-0.208-0.166-0.208-0.46-0.018-0.639    c0.191-0.18,0.772-0.166,1.323-0.126c0.378,0.026,0.762,0.008,1.153-0.03c2.874-0.277,5.544-3.512,7.618-5.218    c0.188-0.154,0.375-0.31,0.563-0.464c0.311-0.255,0.433-0.317,0.376-0.094c-0.058,0.226-0.396,0.719-0.801,1.096    c-1.234,1.146-2.469,2.294-3.702,3.44c-0.404,0.377-0.323,0.805,0.192,0.793c0.517-0.011,1.25-0.448,1.657-0.822    c0.616-0.564,1.232-1.131,1.849-1.696c0.406-0.373,0.761-0.263,0.8,0.249c0.032,0.416,0.059,0.754,0.059,0.927    C23.305,36.88,22.961,42.374,23.126,44.648z M26.209,33.136c0.054-0.549,0.465-0.795,0.784-0.523    c0.318,0.271,0.417,0.652,0.237,0.827c-0.179,0.175-0.176,0.178,0.006,0.006c0.182-0.171,0.521-0.123,0.758,0.107    c0.172,0.168,0.321,0.312,0.438,0.408c0.147,0.121,0.293,0.241,0.44,0.362c0.243,0.2,0.109,0.664-0.297,1.038    c-0.537,0.493-1.032,0.95-1.478,1.361c-0.404,0.375-0.772,0.233-0.819-0.316C26.189,35.344,26.111,34.141,26.209,33.136z     M35.189,37.987c0.729-0.084,1.414-0.196,2.071-0.552c0.213-0.116,0.399-0.195,0.559-0.245c0.321-0.101,0.595,0.013,0.609,0.022    c0.017,0.012,0.179,0.471-0.104,0.943c-0.087,0.146-0.198,0.299-0.333,0.455c-0.36,0.419-1.108,0.919-1.578,1.208    c-1.523,0.938-3.047,1.877-4.571,2.814c-1.182,0.729-2.363,1.456-3.545,2.185c-0.414,0.255-0.829,0.51-1.243,0.766    c-0.153,0.094-0.264,0.169-0.344,0.225c-0.188,0.127-0.192-0.062-0.178-0.025c0.014,0.036,0.336-0.264,0.713-0.667    c0.663-0.708,1.328-1.417,1.993-2.127c0.378-0.403,0.684-1.178,0.684-1.73v-0.735c0-0.553-0.318-0.685-0.71-0.295    c-0.714,0.708-1.433,1.415-2.156,2.12c-0.395,0.386-0.716,0.953-0.716,1.271c0,0.316-0.051,0.128-0.066-0.425    c-0.03-1.144,0.066-2.345,0.121-3.479c0.026-0.552,0.35-1.316,0.739-1.708c0.681-0.683,1.376-1.38,2.082-2.088    c0.39-0.391,1.058-0.432,1.488-0.085c0.483,0.392,0.969,0.789,1.454,1.188C33.028,37.735,34.048,38.119,35.189,37.987z     M45.576,29.941c-1.96,1.151-3.92,2.304-5.881,3.456c-1.026,0.604-2.214,1.624-3.442,1.986c-0.53,0.156-0.731-0.133-0.415-0.458    c0.316-0.324,0.33-0.799,0.031-1.059c-0.299-0.259-0.857-0.152-1.246,0.239c-0.03,0.029-0.06,0.06-0.089,0.09    c-0.39,0.392-0.884,0.556-1.103,0.365c-0.22-0.19-0.082-0.663,0.308-1.057c0.028-0.028,0.059-0.059,0.088-0.088    c0.389-0.393,0.663-0.746,0.611-0.79c-0.05-0.044-0.398,0.247-0.778,0.648c-0.028,0.028-0.057,0.059-0.083,0.088    c-0.38,0.401-0.943,0.506-1.257,0.232c-0.314-0.271-0.264-0.819,0.113-1.223c0.028-0.03,0.057-0.06,0.084-0.09    c0.377-0.404,0.508-0.882,0.292-1.068l-0.39-0.338c-0.07-0.06-0.131-0.124-0.186-0.188c-0.094-0.112-0.471,0.104-0.859,0.494    c-0.049,0.049-0.099,0.098-0.146,0.146c-0.39,0.391-0.731,0.687-0.766,0.658c-0.021-0.019-0.039-0.035-0.059-0.052    c-0.61-0.53-1.112-1.019-1.398-1.492s0.061-1.27,0.447-1.664c0.121-0.124,0.242-0.248,0.362-0.371    c0.387-0.395,1.082-0.947,1.555-1.234c1.373-0.833,2.747-1.667,4.12-2.5c1.111-0.676,2.339-1.797,3.621-2.12    c0.535-0.135,0.674,0.245,0.281,0.634c-0.82,0.814-1.645,1.631-2.472,2.455c-0.392,0.39-0.326,0.473,0.146,0.186l2.545-1.544    c0.472-0.287,1.028-0.706,1.243-0.936c0.215-0.23,0.769-0.177,1.201,0.166c1.012,0.803,1.963,1.818,2.895,2.608    C46.51,27.446,47.798,28.636,45.576,29.941z"/>
        <path d="M37.439,3.521c-1.824-1.127-4.089-0.166-5.55,1.047c-2.075,1.723-4.767,3.342-6.309,5.576    c-1.284,1.861,10.61,7.899,12.123,8.823c0.009,0.005,0.021,0.008,0.033,0.01c0.019,0.004,0.046,0.019,0.06,0.032    c0.006,0.006,0.014,0.012,0.027,0.016c2.373,0.781,4.048,0.048,5.892-1.462c1.664-1.363,5.081-3.138,5.934-5.247    C50.574,10.028,39.173,4.59,37.439,3.521z M28.152,10.811c-0.938-2.328,3.978-5.065,5.812-6.587    c0.293-0.244,0.771-0.26,1.37-0.116c0.537,0.129,0.622,0.623,0.221,1.003c-0.807,0.763-1.737,1.642-2.812,2.66    c-1.514,1.445-2.556,2.444-3.286,3.146C29.059,11.298,28.357,11.322,28.152,10.811z M45.766,14.522    c-1.346,1.102-3.356,3.558-5.341,3.793c-0.548,0.065-1.304-0.277-1.692-0.515c-0.389-0.238-0.42-0.682-0.069-0.992    c0.351-0.311,0.594-0.586,0.544-0.617s-0.361,0.205-0.693,0.526c-0.332,0.321-0.85,0.43-1.156,0.243    c-0.306-0.188-0.282-0.599,0.052-0.919c0.334-0.32,0.556-0.609,0.496-0.645c-0.061-0.037-0.378,0.195-0.708,0.517    c-0.331,0.322-0.341,0.314-0.017-0.011c0.325-0.326,0.301-0.347-0.038-0.029s-0.987,0.352-1.459,0.064    c-0.099-0.06-0.197-0.121-0.296-0.181c-0.471-0.288-0.578-0.778-0.238-1.095c0.341-0.317,0.362-0.729,0.05-0.92    c-0.313-0.191-0.844-0.09-1.185,0.226s-0.886,0.408-1.218,0.206c-0.331-0.203-0.322-0.623,0.02-0.938    c0.343-0.315,0.477-0.658,0.299-0.767c-0.179-0.108-0.597,0.061-0.936,0.379c-0.339,0.317-0.879,0.411-1.208,0.21    c-0.329-0.201-0.315-0.619,0.027-0.933c0.344-0.315,0.566-0.604,0.503-0.653c-0.063-0.048-0.376,0.18-0.704,0.513    s-0.782,0.488-1.015,0.346c-0.141-0.085-0.28-0.171-0.42-0.257c-0.04-0.025-0.079-0.05-0.115-0.075    c-0.063-0.043,0.201-0.399,0.587-0.794c0.122-0.125,0.244-0.249,0.366-0.374c0.386-0.395,0.744-0.956,0.905-1.2    c0.092-0.137,0.21-0.269,0.356-0.391l0.799-0.664c0.425-0.353,1.084-0.959,1.47-1.354c0.672-0.685,1.333-1.36,1.989-2.028    c0.387-0.394,1.114-0.54,1.606-0.29c3.181,1.616,7.424,4.936,8.472,5.583C47.838,11.746,47.54,13.068,45.766,14.522z"/>
        <path d="M7.844,30.971c-0.351,0.373-0.458,0.78-0.24,0.908c0.22,0.128,0.703-0.056,1.083-0.413c0.38-0.356,0.487-0.763,0.24-0.908    C8.68,30.413,8.195,30.599,7.844,30.971z"/>
        <path d="M32.163,5.779c0.396-0.385,0.657-0.648,0.583-0.586l-0.134,0.111c-0.642,0.632-1.28,1.262-1.93,1.903    c-0.394,0.388-0.392,0.391,0.004,0.006C31.176,6.739,31.668,6.26,32.163,5.779z"/>
    </g>
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>
<g xmlns="http://www.w3.org/2000/svg">
</g>`
        );
        this.addRibbonIcon("insertRow", "Backup to Dropbox", async () => {
            await this.backup();
        });

        this.registerInterval(
            window.setInterval(async () => {
                await this.backup();
            }, 60000 * 10)
        );

        await this.backup();
    }

    onunload() {
        console.log("Unloading Dropbox Backups plugin ...");
    }
}
